# This is a workflow template for a workflow which looks up a collection of resources (i.e., pods)
# and for each of them stores the output in an artifact repository.
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: collect-outputs-template
spec:
  templates:
  - name: main
    inputs:
      parameters:
      # Required
      - name: volume
      # Default
      - name: kind
        value: pods
      - name: selector
        value: ''
      - name: registry
        value: docker-registry.default.svc:5000
      - name: thoth-infra-namespace
        value: "{{workflow.namespace}}"
    steps:
    - - name: get-resources
        arguments:
          parameters:
          - name: image
            value: |-
              {{inputs.parameters.registry}}/{{inputs.parameters.thoth-infra-namespace}}/kubectl
          - name: kind
            value: "{{inputs.parameters.kind}}"
          - name: selector
            value: "{{inputs.parameters.selector}}"
        template: get-resources
    - - name: store-output
        arguments:
          parameters:
          - name: image
            value: |-
              {{inputs.parameters.registry}}/{{inputs.parameters.thoth-infra-namespace}}/kubectl
          - name: resource
            value: "{{item}}"
          - name: volume
            value: "{{inputs.parameters.volume}}"
        template: store-output
        withParam: "{{steps.get-resources.outputs.result}}"

  - name: get-resources
    inputs:
      parameters:
      - name: image
      - name: kind
      - name: selector
    script:
      image: "{{inputs.parameters.image}}"
      command: [sh]
      source: >-
        kubectl get {{inputs.parameters.kind}} -l {{inputs.parameters.selector}} -o json |
        jq '.items[].metadata | { name }' |
        jq -s .
      resource:
        limits:
          cpu: 100m
          memory: 32Mi

  - name: store-output
    inputs:
      parameters:
      - name: image
      - name: resource
      - name: volume
    outputs:
      artifacts:
      - name: output
        path: "/mnt/output/artifact"
    container:
      image: "{{inputs.parameters.image}}"
      command: [sh, -c]
      args: ["
        kubectl logs {{inputs.parameters.resource}} | tee /mnt/output/artifact
      "]
      # Required so that `kubelet/k8sapi` executors could gather outputs
      # NOTE: The volume has to be created by the caller's workflow, since
      # WorkflowTemplateSpec does not allow to specify volumes
      # see https://github.com/argoproj/argo/blob/master/pkg/apis/workflow/v1alpha1/workflow_template_types.go
      resource:
        limits:
          cpu: 100m
          memory: 32Mi
      volumeMounts:
      - name: '{{inputs.parameters.volume}}'
        mountPath: /mnt/output
